name: Scheduled Checks

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

env:
  CARGO_TERM_COLOR: always

jobs:
  security-audit:
    name: Weekly Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security vulnerabilities detected',
              body: 'The weekly security audit found vulnerabilities. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.',
              labels: ['security', 'automated']
            })

  dependency-check:
    name: Weekly Dependency Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check for outdated dependencies
        id: outdated
        run: |
          cargo outdated --format json > outdated.json
          cat outdated.json

      - name: Create issue on outdated dependencies
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));
              if (outdated.dependencies && outdated.dependencies.length > 0) {
                let body = '## Outdated Dependencies\n\n';
                body += 'The following dependencies have updates available:\n\n';
                body += '| Package | Current | Latest | Kind |\n';
                body += '|---------|---------|--------|------|\n';

                for (const dep of outdated.dependencies) {
                  body += `| ${dep.name} | ${dep.project} | ${dep.latest} | ${dep.kind || 'normal'} |\n`;
                }

                body += `\n[Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: 'Dependencies available for update',
                  body: body,
                  labels: ['dependencies', 'automated']
                });
              }
            } catch (error) {
              console.log('No outdated dependencies or error parsing output');
            }

  cargo-deny:
    name: Cargo Deny Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cargo Deny
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          log-level: warn
          command: check
          arguments: --all-features
